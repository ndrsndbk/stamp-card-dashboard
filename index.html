
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Potential Company — WhatsApp Stamp Card Dashboard</title>
  <style>
    :root {
      --green-primary: #007749;
      --green-dark: #005835;
      --green-deep: #003722;
      --green-soft: #00965c;

      --bg: var(--green-primary);
      --panel: rgba(0, 0, 0, 0.18);
      --border: rgba(255, 255, 255, 0.25);
      --text: #ffffff;
      --muted: rgba(255, 255, 255, 0.65);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at top left, #009d5d 0, var(--bg) 55%, var(--green-deep) 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 20px;
      background: rgba(0, 0, 0, 0.18);
      border-bottom: 1px solid rgba(255, 255, 255, 0.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    header img.logo {
      height: 46px;
      width: auto;
      display: block;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    main {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 26px 14px 34px;
      flex: 1 0 auto;
    }

    .metrics-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .metric-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px 18px 16px;
      text-align: center;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease,
        border-color 0.15s ease;
    }

    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 38px rgba(0, 0, 0, 0.55);
      border-color: rgba(255, 255, 255, 0.32);
    }

    .metric-title {
      font-size: 13px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .metric-value {
      font-size: 26px;
      font-weight: 800;
      margin: 0;
      color: var(--text);
    }

    .metric-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      padding: 12px 10px 20px;
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <header>
    <!-- Updated Logo -->
    <img src="logo3.png" alt="The Potential Company Logo" class="logo" />
    <h1>WhatsApp Stamp Card Dashboard</h1>
  </header>

  <main>
    <section class="metrics-container">
      <div class="metric-card">
        <div class="metric-title">Total Stamp Cards</div>
        <p class="metric-value" id="total_cards">0</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Cards Created (Last 30 Days)</div>
        <p class="metric-value" id="cards_last_30d">0</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Cards Created (Last 7 Days)</div>
        <p class="metric-value" id="cards_last_7d">0</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Cards Created (Last 24 Hours)</div>
        <p class="metric-value" id="cards_last_1d">0</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Total Stamps</div>
        <p class="metric-value" id="total_stamps">0</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Stamps Redeemed</div>
        <p class="metric-value" id="stamps_redeemed">0</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Redemption Rate %</div>
        <p class="metric-value" id="redemption_rate_pct">0%</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">ROI %</div>
        <p class="metric-value" id="roi_pct">0%</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Stamps Today</div>
        <p class="metric-value" id="stamps_today">0</p>
        <div class="metric-note" id="stamps_today_note">
          Live Sales Today (date)
        </div>
      </div>
    </section>
  </main>

  <footer>
    © 2025 Meta Loyalty Systems — Powered by The Potential Company
  </footer>

  <script type="module">
    const SUPABASE_URL =
      "https://lhbtgjvejsnsrlstwlwl.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoYnRnanZlanNuc3Jsc3R3bHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxODYzMjQsImV4cCI6MjA3MTc2MjMyNH0.tEKLgAaaZZ1jnODoEYWkFYbdBWYZGI1Lu-6rBvrzXBI";

    async function loadDashboard() {
      // Main totals
      const rpcRes = await fetch(
        `${SUPABASE_URL}/rest/v1/rpc/get_stampcard_dashboard`,
        {
          method: "POST",
          headers: {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({}),
        }
      );

      if (rpcRes.ok) {
        const [data] = await rpcRes.json();

        if (data) {
          document.getElementById("total_cards").innerText =
            data.total_cards?.toLocaleString() || 0;

          document.getElementById("cards_last_30d").innerText =
            data.cards_last_30d?.toLocaleString() || 0;

          document.getElementById("cards_last_7d").innerText =
            data.cards_last_7d?.toLocaleString() || 0;

          document.getElementById("cards_last_1d").innerText =
            data.cards_last_1d?.toLocaleString() || 0;

          document.getElementById("total_stamps").innerText =
            data.total_stamps?.toLocaleString() || 0;

          document.getElementById("stamps_redeemed").innerText =
            data.stamps_redeemed?.toLocaleString() || 0;

          document.getElementById("redemption_rate_pct").innerText =
            data.redemption_rate_pct
              ? `${data.redemption_rate_pct.toFixed(1)}%`
              : "0%";

          document.getElementById("roi_pct").innerText =
            data.roi_pct ? `${data.roi_pct.toFixed(0)}%` : "0%";
        }
      }

      await loadStampsToday();
    }

    function updateStampsTodayNote() {
      const today = new Date();
      const f = today.toLocaleDateString("en-US", {
        weekday: "short",
        month: "short",
        day: "numeric",
      });

      document.getElementById("stamps_today_note").innerText =
        `Live Sales Today (${f})`;
    }

    updateStampsTodayNote();

    async function loadStampsToday() {
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);

      const startIso = start.toISOString();
      const endIso = end.toISOString();

      const url = `${SUPABASE_URL}/rest/v1/customers?select=customer_id,last_visit_at&last_visit_at=gte.${startIso}&last_visit_at=lt.${endIso}`;

      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
        },
      });

      if (!res.ok) return;

      const rows = await res.json();
      const count = rows.length || 0;

      document.getElementById("stamps_today").innerText =
        count.toLocaleString();
    }

    loadDashboard();
  </script>
</body>
</html>

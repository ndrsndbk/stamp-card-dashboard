<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Potential Company â€” WhatsApp Stamp Card Dashboard</title>
  <style>
    :root {
      --bg: #121212;
      --panel: #1e1e1e;
      --border: #2e2e2e;
      --accent: #00E676;
      --text: #f5f5f5;
      --muted: #9e9e9e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 24px;
      background: #1c1c1c;
      border-bottom: 2px solid var(--accent);
    }

    header img.logo {
      height: 48px;
      width: auto;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 16px 40px;
    }

    .metrics-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }

    .metric-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px 18px 16px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.24);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 230, 118, 0.2);
    }

    .metric-title {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--text);
      margin: 0;
    }

    .metric-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      padding: 16px 0 24px;
    }
  </style>
</head>
<body>
  <header>
    <!-- Make sure tpc_logo.png is in the SAME folder as this file -->
    <img src="tpc_logo.png" alt="The Potential Company Logo" class="logo" />
    <h1>The Potential Company â€” Stamp Card Dashboard</h1>
  </header>

  <main>
    <section class="metrics-container">
      <!-- Row 1 -->
      <div class="metric-card">
        <div class="metric-title">Total Stamp Cards</div>
        <p class="metric-value" id="total_cards">0</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Cards Created (Last 30 Days)</div>
        <p class="metric-value" id="cards_last_30d">0</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Cards Created (Last 7 Days)</div>
        <p class="metric-value" id="cards_last_7d">0</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Cards Created (Last 24 Hours)</div>
        <p class="metric-value" id="cards_last_1d">0</p>
      </div>

      <!-- Row 2 -->
      <div class="metric-card">
        <div class="metric-title">Total Stamps</div>
        <p class="metric-value" id="total_stamps">0</p>
      </div>

      <div class="metric-card">
        <div class="metric-title">Stamps Redeemed</div>
        <p class="metric-value" id="stamps_redeemed">0</p>
      </div>

      <div class="metric-card" title="Percentage of stamps that resulted in a reward redemption">
        <div class="metric-title">Redemption Rate %</div>
        <p class="metric-value" id="redemption_rate_pct">0%</p>
      </div>

      <div class="metric-card" title="ROI = Total Stamps Ã· Redemptions Ã— 100. Shows how many visits each reward generated.">
        <div class="metric-title">ROI %</div>
        <p class="metric-value" id="roi_pct">0%</p>
      </div>

      <!-- Row 3 (will appear as second row on wider screens if enough columns) -->
      <div class="metric-card">
        <div class="metric-title">Stamps Today</div>
        <p class="metric-value" id="stamps_today">0</p>
        <div class="metric-note" id="stamps_today_note">
        Live Sales today (date)
        </div>

      </div>
    </section>
  </main>

  <footer>
    Â© 2025 Meta Loyalty Systems â€” Powered by The Potential Company
  </footer>

  <script type="module">
    // ðŸ‘‰ Fill these in from Supabase Project Settings â†’ API
    const SUPABASE_URL = "https://lhbtgjvejsnsrlstwlwl.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoYnRnanZlanNuc3Jsc3R3bHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxODYzMjQsImV4cCI6MjA3MTc2MjMyNH0.tEKLgAaaZZ1jnODoEYWkFYbdBWYZGI1Lu-6rBvrzXBI";

    async function loadDashboard() {
      // 1) Main metrics via RPC
      const rpcRes = await fetch(
        `${SUPABASE_URL}/rest/v1/rpc/get_stampcard_dashboard`,
        {
          method: "POST",
          headers: {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({}),
        }
      );

      if (!rpcRes.ok) {
        console.error("Failed to load dashboard data:", await rpcRes.text());
      } else {
        const [data] = await rpcRes.json();

        if (data) {
          document.getElementById("total_cards").innerText =
            (data.total_cards ?? 0).toLocaleString();

          document.getElementById("cards_last_30d").innerText =
            (data.cards_last_30d ?? 0).toLocaleString();

          document.getElementById("cards_last_7d").innerText =
            (data.cards_last_7d ?? 0).toLocaleString();

          document.getElementById("cards_last_1d").innerText =
            (data.cards_last_1d ?? 0).toLocaleString();

          document.getElementById("total_stamps").innerText =
            (data.total_stamps ?? 0).toLocaleString();

          document.getElementById("stamps_redeemed").innerText =
            (data.stamps_redeemed ?? 0).toLocaleString();

          document.getElementById("redemption_rate_pct").innerText =
            data.redemption_rate_pct
              ? `${Intl.NumberFormat("en-US", {
                  maximumFractionDigits: 1,
                }).format(data.redemption_rate_pct)}%`
              : "0%";

          document.getElementById("roi_pct").innerText =
            data.roi_pct
              ? `${Intl.NumberFormat("en-US", {
                  maximumFractionDigits: 0,
                }).format(data.roi_pct)}%`
              : "0%";
        }
      }

      // 2) Stamps Today via last_visit_at
      await loadStampsToday();
    }
    // Insert today's date into the "Live Sales today" note
function updateStampsTodayNote() {
  const today = new Date();
  const formatted = today.toLocaleDateString("en-US", {
    weekday: "short",
    month: "short",
    day: "numeric"
  });

  document.getElementById("stamps_today_note").innerText =
    `Live Sales Today (${formatted})`;
}

updateStampsTodayNote();


    async function loadStampsToday() {
      const now = new Date();
      const startLocal = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        0,
        0,
        0,
        0
      );
      const endLocal = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate() + 1,
        0,
        0,
        0,
        0
      );

      const startUtcIso = startLocal.toISOString();
      const endUtcIso = endLocal.toISOString();

      const url = `${SUPABASE_URL}/rest/v1/customers?select=customer_id,last_visit_at&last_visit_at=gte.${startUtcIso}&last_visit_at=lt.${endUtcIso}`;

      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
        },
      });

      if (!res.ok) {
        console.error("Failed to load 'Stamps Today':", await res.text());
        return;
      }

      const rows = await res.json();
      const uniqueCustomersToday = rows.length || 0;

      document.getElementById("stamps_today").innerText =
        uniqueCustomersToday.toLocaleString();
    }

    loadDashboard();
  </script>
</body>
</html>

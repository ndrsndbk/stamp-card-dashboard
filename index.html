<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stamp Card Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: white;
            padding: 20px;
        }
        h1 {
            text-align: left;
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        .metric-card {
            background-color: #1f1f1f;
            border-radius: 10px;
            padding: 18px;
            text-align: center;
            box-shadow: 0px 0px 10px rgba(255, 255, 255, 0.05);
        }
        .metric-title {
            font-size: 16px;
            color: #bdbdbd;
            margin-bottom: 6px;
        }
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .metric-subtext {
            font-size: 12px;
            color: #7e7e7e;
        }
        .bottom-row {
            margin-top: 40px;
        }
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr;
        }
        .logo {
            width: 48px;
            height: 48px;
        }
    </style>
</head>

<body>

<h1>
    <img class="logo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAABUFBMVEUAAAD///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8f1RyEAAAAtXRSTlMAAgMEBQYHCAkKCwwNDg8QERITFBUWFxgZGhscHR4fICEiIyQlJicoKSorLC0uLzAxMjM0NTY3ODk6Ozw9Pj9AQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVpbXF1eX2BhYmNkZWZnaGlqamtsbW5vcHFyc3R1dnd4eXp7fH1+f4CBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7p6U9lAAAG20lEQVR4nO2d93+bOBSAI1IqiKJWKAtR0tLa2trYtttttttu//9/PZgZDBAkWaG33vXvOe9y0Z9JwgJDDO48znPM6xAERERERERERERERERERERERERERERERERqSB8bzl9RgxN2KJ2VN8iEsXVP8nTCJlx7edFpjdLyCxpMCzYCGPdrF5SLI05aO3Y61DwJgkS2NZoJA0c/biPH7xDxuPsbNx1LT94m8bm7lL54tGfYyKS2hMjW2wdvT4HQHPPY9jSPOu8guGbN0EJjRqiXO5pI9un4aT4zAtpNq2FsYvY0vMlT+t2hW8h1VlaTW84hiM4RwSRfl5IU7GEqiy0Mf4VuwmkwijZvWkpQZJrNbs7wR1h6qj34O4GjpObQZJrNhawvZXe7TJyPosg7X1GMl3Zb4SzgpeaTP8zYbG0cM28YEW8pJhtqpejq7s73ZyqdmFDLHjF6Zn9tbc8CS8ImWjK8obqp3cbvcv+ZrYzCivInXmpcDZcg4IbnQ3XOkc/NzgWXhljxJ3g6vLi1jYFzyLGWz48m42Khp7Ep1yx4xceNlIjJ2mJwS9Xu8Dd3YpC42mJwR7rpR0UiMqYjCxqnprCHUQkqJwTGmZcErAkJP0t6i8RaSZBJn0pKRGxrhRFHLJpDEBqZlNlB7qEIaJgR5qZl0pAo1Ikwia01JxG+CQGmJUyVJQAOjQiwSZk1JyG+CSJCwpa0FCQCOzwiwCZn1ZyCOySi4zExL6ty52kZ/t2rF4k80SWg9bUpFxJtbnYAjJpoNZTWkXElG7dgCMmmg1lNaRcSUbt2AIyaaDWU1pFxJRu3YAjJpoNZTWkXElG7dgCMmmg1lNaRcSUbt2AIyaaDWU1pFxJRu3YAjJpoNZTWkXElG7dgCMvov8AGrVYtE+b4URYAAAAASUVORK5CYII=">
    Stamp Card Dashboard
</h1>

<div class="metrics-container">
    <div class="metric-card" id="total_stampcards">
        <div class="metric-title">Total Stamp Cards</div>
        <div class="metric-value">0</div>
    </div>

    <div class="metric-card" id="stampcards_30">
        <div class="metric-title">New in Last 30 Days</div>
        <div class="metric-value">0</div>
    </div>

    <div class="metric-card" id="stampcards_7">
        <div class="metric-title">New in Last 7 Days</div>
        <div class="metric-value">0</div>
    </div>

    <div class="metric-card" id="stampcards_1">
        <div class="metric-title">New in Last 24 Hours</div>
        <div class="metric-value">0</div>
    </div>

    <div class="metric-card" id="total_stamps">
        <div class="metric-title">Total Stamps</div>
        <div class="metric-value">0</div>
    </div>

    <div class="metric-card" id="total_redemptions">
        <div class="metric-title">Total Redemptions</div>
        <div class="metric-value">0</div>
    </div>

    <div class="metric-card" id="roi_stampcard">
        <div class="metric-title">Stamp Card ROI</div>
        <div class="metric-value">0%</div>
        <div class="metric-subtext">Stamps ÷ Redemptions</div>
    </div>
</div>

<!-- BOTTOM ROW – STAMPS TODAY -->
<div class="bottom-row">
    <div class="bottom-grid">
        <div class="metric-card" id="stamps_today">
            <div class="metric-title">Stamps Today</div>
            <div class="metric-value">0</div>
        </div>
    </div>
</div>

<!-- SUPABASE JS -->
<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // TODO: REPLACE THESE
    const SUPABASE_URL = "https://YOURPROJECT.supabase.co";
    const SUPABASE_KEY = "YOUR-ANON-KEY";

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    async function loadDashboard() {
        const { data, error } = await supabase.from("customers").select("*");
        if (error) {
            console.error(error);
            return;
        }

        const now = new Date();
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startUtcIso = new Date(Date.UTC(startOfToday.getFullYear(), startOfToday.getMonth(), startOfToday.getDate())).toISOString();

        const stampsToday = data.filter(c => c.last_visit_at && new Date(c.last_visit_at) >= new Date(startUtcIso)).length;

        const totalStampcards = data.length;
        const last30 = data.filter(c => Date.now() - new Date(c.created_at).getTime() < 30*24*3600*1000).length;
        const last7  = data.filter(c => Date.now() - new Date(c.created_at).getTime() < 7*24*3600*1000).length;
        const last1  = data.filter(c => Date.now() - new Date(c.created_at).getTime() < 1*24*3600*1000).length;

        const totalStamps = data.reduce((a, c) => a + (c.number_of_visits || 0), 0);
        const totalRedemptions = data.reduce((a, c) => a + Math.floor((c.number_of_visits || 0) / 10), 0);

        const roi = totalRedemptions === 0 ? "∞" : ((totalStamps / totalRedemptions) * 100).toFixed(1) + "%";

        document.getElementById("total_stampcards").querySelector(".metric-value").textContent = totalStampcards;
        document.getElementById("stampcards_30").querySelector(".metric-value").textContent = last30;
        document.getElementById("stampcards_7").querySelector(".metric-value").textContent = last7;
        document.getElementById("stampcards_1").querySelector(".metric-value").textContent = last1;

        document.getElementById("total_stamps").querySelector(".metric-value").textContent = totalStamps;
        document.getElementById("total_redemptions").querySelector(".metric-value").textContent = totalRedemptions;

        document.getElementById("roi_stampcard").querySelector(".metric-value").textContent = roi;
        document.getElementById("stamps_today").querySelector(".metric-value").textContent = stampsToday;
    }

    loadDashboard();
</script>

</body>
</html>
